name: Build & Deploy Docker (Optimized Multi-Arch)

on:
  push:
    branches: ["main"]
    paths:
      - "Dockerfile"
      - "entrypoint.sh"
      - ".github/workflows/docker.yml"
  workflow_dispatch: {}

jobs:
  build-test:
    name: Quick Test Build (amd64 Only)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # --- FAST TEST: amd64 ONLY ---
      - name: Test Build (No Push, Cached)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy Multi-Arch to GHCR
    runs-on: ubuntu-latest
    needs: build-test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare tags
        id: vars
        run: |
          IMAGE="ghcr.io/${{ github.repository_owner }}/ptero-js"
          SHA="${{ github.sha }}"
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "sha=$SHA" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # --- MAIN MULTI-ARCH BUILD + PUSH ---
      - name: Build & Push Image (Multi-Arch
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ steps.vars.outputs.image }}:latest
            ${{ steps.vars.outputs.image }}:${{ steps.vars.outputs.sha }}

  cleanup:
    name: Cleanup Old Images
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Authenticate GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Keep last 10 tags
      - name: Delete Old Tags
        uses: actions/delete-package-versions@v5
        with:
          package-name: "ptero-js"
          package-type: "container"
          min-versions-to-keep: 10

      # Delete untagged (dangling) images, keep 3
      - name: Delete Old Untagged
        run: |
          REPO="ptero-js"
          USER="${{ github.repository_owner }}"

          IDS=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/users/$USER/packages/container/$REPO/versions |
            jq -r '.[] | select(.metadata.container.tags | length == 0) | .id')

          COUNT=$(echo "$IDS" | wc -l)
          KEEP=3

          if [ "$COUNT" -le "$KEEP" ]; then
            echo "No dangling cleanup needed."
            exit 0
          fi

          DELETE=$(echo "$IDS" | tail -n +$((KEEP+1)))

          echo "Deleting untagged images:"
          echo "$DELETE"

          for id in $DELETE; do
            curl -X DELETE \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/users/$USER/packages/container/$REPO/versions/$id
          done
