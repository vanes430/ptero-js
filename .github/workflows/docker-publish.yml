name: Build & Deploy Docker (Multi-Arch)

on:
  push:
    branches: [ "main" ]
    paths:
      - "Dockerfile"
      - "entrypoint.sh"
      - ".github/workflows/docker.yml"
  workflow_dispatch: {}

jobs:
  build-test:
    name: Build (Test) Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Test build (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: false

  deploy:
    name: Build & Push to GHCR
    runs-on: ubuntu-latest
    needs: build-test
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare image tags
        id: vars
        run: |
          IMAGE="ghcr.io/${{ github.repository_owner }}/ptero-js"
          VERSION="${{ github.sha }}"
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push (Multi-arch)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ steps.vars.outputs.image }}:latest
            ${{ steps.vars.outputs.image }}:${{ github.sha }}

  cleanup:
    name: Cleanup Old Images
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Authenticate ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old tags (keep last 10)
        uses: actions/delete-package-versions@v5
        with:
          package-name: "ptero-js"
          package-type: "container"
          min-versions-to-keep: 10

      - name: Delete old untagged images (dangling), keep 3
        run: |
          REPO="ghcr.io/${{ github.repository_owner }}/ptero-js"

          echo "Fetching dangling imagesâ€¦"
          IDS=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/users/${{ github.repository_owner }}/packages/container/ptero-js/versions |
            jq -r '.[] | select(.metadata.container.tags | length == 0) | .id')

          COUNT=$(echo "$IDS" | wc -l)
          KEEP=3

          if [ "$COUNT" -le "$KEEP" ]; then
            echo "No cleanup required."
            exit 0
          fi

          DELETE=$(echo "$IDS" | tail -n +$((KEEP+1)))

          echo "Deleting old untagged images:"
          echo "$DELETE"

          for id in $DELETE; do
            curl -X DELETE \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/users/${{ github.repository_owner }}/packages/container/ptero-js/versions/$id
          done
